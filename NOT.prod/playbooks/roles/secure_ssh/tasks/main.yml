---
# tasks file for secure_ssh


- name: Create group
  ansible.builtin.group:
    name: "{{ user_group }}"
    state: present

- name: Create user
  user:
    name: "{{ user_name }}"
    password: "{{ user_passwd }}"
    group: "{{ user_group }}"
    groups: sudo
    append: yes
    create_home: yes
    shell: /bin/bash
    state: present

- name: Create .ssh
  file:
    path: /home/"{{ user_name }}"/.ssh/
    state: directory
    owner: "{{ user_name }}"
    group: "{{ user_group }}"
    mode: 0700

- name: Create authorized_keys
  file:
    dest: /home/"{{ user_name }}"/.ssh/authorized_keys
    state: touch
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0600

- name: static public key
  lineinfile:
    path: /home/"{{ user_name }}"/.ssh/authorized_keys
    line: "{{ user_pubkey }}"
    
- name: Disable PasswordAuthentication
  lineinfile:
    path: "{{ path_sshd_config }}"
    regexp: ^#PasswordAuthentication
    line: 'PasswordAuthentication no'
  notify: restart_ssh

- name: Disable PermitRootLogin
  lineinfile:
    path: "{{ path_sshd_config }}"
    regexp: ^#PermitRootLogin
    line: 'PermitRootLogin no'

- name: Disable ChallengeResponseAuthentication
  lineinfile:
    path: "{{ path_sshd_config }}"
    regexp: ^#ChallengeResponseAuthentication
    line: 'ChallengeResponseAuthentication no'

- name: Disable UsePAM
  lineinfile:
    path: "{{ path_sshd_config }}"
    regexp: ^#UsePAM
    line: 'UsePAM no'

- name: Add AuthenticationMethods publickey
  lineinfile:
    path: "{{ path_sshd_config }}"
    line: 'AuthenticationMethods publickey'

- name: Add PubkeyAuthentication
  lineinfile:
    path: "{{ path_sshd_config }}"
    line: 'PubkeyAuthentication yes'

- name: Limint users
  lineinfile:
    path: "{{ path_sshd_config }}"
    line: 'AllowUsers "{{ user_name }}"'

- name: Disable PermitEmptyPasswords
  lineinfile:
    path: "{{ path_sshd_config }}"
    regexp: ^#PermitEmptyPasswords
    line: 'PermitEmptyPasswords no'
- 
    

